<!DOCTYPE html>
<html>
<head>
  <title>Simple L-System Trees</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js"></script>
  <link rel="stylesheet" href="../../pen-plotter/shared/responsive.css">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
    }
    #canvas-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f5f5f5;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: hidden;
    }
    #controls {
      width: 250px;
      padding: 20px;
      background: #333;
      color: white;
      height: 100vh;
      overflow-y: auto;
      box-sizing: border-box;
    }
    h3 {
      margin: 15px 0 10px 0;
      color: #4CAF50;
      font-size: 14px;
    }
    .control {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
    }
    input[type="range"] {
      width: 100%;
    }
    button {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }
    button:hover {
      background: #45a049;
    }
    .preset {
      background: #666;
    }
    .preset:hover {
      background: #777;
    }
    .value {
      font-weight: bold;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <a href="../../../index.html" class="back-link"
     style="position: fixed; top: 15px; left: 15px; z-index: 1000;
            color: #4CAF50; text-decoration: none; font-size: 14px;
            background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 20px;
            transition: all 0.2s ease; border: 1px solid #4CAF50;"
     onmouseover="this.style.background='rgba(76,175,80,0.3)'"
     onmouseout="this.style.background='rgba(0,0,0,0.8)'">
    ← Back to Browser
  </a>
  <div id="canvas-container"></div>
  <div id="controls">
    <h2>L-System Trees</h2>
    
    <h3>Quick Presets</h3>
    <button class="preset" onclick="loadPreset('simple')">Simple Tree</button>
    <button class="preset" onclick="loadPreset('organic')">Organic</button>
    <button class="preset" onclick="loadPreset('willow')">Willow</button>
    <button class="preset" onclick="loadPreset('fern')">Fern</button>
    
    <h3>Structure</h3>
    <div class="control">
      <label>Iterations: <span class="value" id="iterations-val">5</span></label>
      <input type="range" id="iterations" min="1" max="8" value="5">
    </div>
    <div class="control">
      <label>Branch Length: <span class="value" id="length-val">10</span></label>
      <input type="range" id="length" min="5" max="30" value="10">
    </div>
    <div class="control">
      <label>Branch Angle: <span class="value" id="angle-val">25</span>°</label>
      <input type="range" id="angle" min="10" max="45" value="25">
    </div>
    <div class="control">
      <label>Length Decay: <span class="value" id="decay-val">0.8</span></label>
      <input type="range" id="decay" min="0.5" max="0.95" step="0.05" value="0.8">
    </div>
    
    <h3>Variation</h3>
    <div class="control">
      <label>Randomness: <span class="value" id="randomness-val">0</span>%</label>
      <input type="range" id="randomness" min="0" max="30" value="0">
    </div>
    <div class="control">
      <label>Wind: <span class="value" id="wind-val">0</span></label>
      <input type="range" id="wind" min="0" max="20" value="0">
    </div>
    
    <h3>Actions</h3>
    <button onclick="regenerate()">Regenerate</button>
    <button onclick="exportSVG()">Export SVG</button>
    <button onclick="exportGIF()">Export GIF</button>
    <div id="gif-status" style="margin-top: 10px; font-size: 12px; color: #888;"></div>
  </div>

  <script>
    let params = {
      iterations: 5,
      length: 10,
      angle: 25,
      decay: 0.8,
      randomness: 0,
      wind: 0,
      axiom: 'F',
      rules: { 'F': 'FF+[+F-F-F]-[-F+F+F]' }
    };
    
    const presets = {
      simple: {
        iterations: 5,
        angle: 25,
        decay: 0.8,
        axiom: 'F',
        rules: { 'F': 'FF+[+F-F-F]-[-F+F+F]' }
      },
      organic: {
        iterations: 4,
        angle: 30,
        decay: 0.75,
        randomness: 15,
        axiom: 'F',
        rules: { 'F': 'F[+F]F[-F][F]' }
      },
      willow: {
        iterations: 5,
        angle: 35,
        decay: 0.85,
        wind: 10,
        axiom: 'F',
        rules: { 'F': 'FF+[+F-FF-F]-[-F+FF+F]' }
      },
      fern: {
        iterations: 6,
        angle: 22,
        decay: 0.9,
        axiom: 'X',
        rules: { 
          'X': 'F+[[X]-X]-F[-FX]+X',
          'F': 'FF'
        }
      }
    };
    
    function setup() {
      let canvas = createCanvas(800, 600);
      canvas.parent('canvas-container');
      
      // Setup controls
      ['iterations', 'length', 'angle', 'decay', 'randomness', 'wind'].forEach(param => {
        document.getElementById(param).addEventListener('input', (e) => {
          params[param] = parseFloat(e.target.value);
          document.getElementById(param + '-val').textContent = e.target.value;
          redraw();
        });
      });
      
      noLoop();
    }
    
    function draw() {
      generate();
    }
    
    function generateLSystem() {
      let current = params.axiom;
      for (let i = 0; i < params.iterations; i++) {
        let next = '';
        for (let char of current) {
          next += params.rules[char] || char;
        }
        current = next;
      }
      return current;
    }
    
    function generate() {
      background(255);
      
      const system = generateLSystem();
      
      push();
      // Start from bottom center
      translate(width / 2, height - 50);
      stroke(0);
      strokeWeight(1);
      
      drawLSystem(system);
      pop();
    }
    
    function drawLSystem(system) {
      const stack = [];
      let len = params.length;
      
      for (let char of system) {
        // Add randomness
        const randAngle = params.randomness ? 
          random(-params.randomness, params.randomness) * PI / 180 : 0;
        const windEffect = params.wind * sin(frameCount * 0.01) * 0.01;
        
        switch (char) {
          case 'F':
            line(0, 0, 0, -len);
            translate(0, -len);
            break;
          case '+':
            rotate((params.angle + randAngle) * PI / 180 + windEffect);
            break;
          case '-':
            rotate((-params.angle + randAngle) * PI / 180 - windEffect);
            break;
          case '[':
            push();
            stack.push(len);
            len *= params.decay;
            break;
          case ']':
            pop();
            len = stack.pop() || len;
            break;
        }
      }
    }
    
    function loadPreset(name) {
      const preset = presets[name];
      if (preset) {
        Object.assign(params, preset);
        
        // Update UI
        Object.keys(preset).forEach(key => {
          const element = document.getElementById(key);
          if (element) {
            element.value = preset[key];
            const valElement = document.getElementById(key + '-val');
            if (valElement) valElement.textContent = preset[key];
          }
        });
        
        generate();
      }
    }
    
    function regenerate() {
      redraw();
    }
    
    function exportSVG() {
      // Create SVG canvas temporarily
      let svgCanvas = createCanvas(800, 600, SVG);
      svgCanvas.parent('canvas-container');
      generate();
      save('lsystem-tree.svg');
      
      // Switch back to regular canvas
      svgCanvas.remove();
      let canvas = createCanvas(800, 600);
      canvas.parent('canvas-container');
      noLoop();
      redraw();
    }
    
    function exportGIF() {
      const statusEl = document.getElementById('gif-status');
      statusEl.textContent = 'Preparing GIF export...';
      
      const gif = new GIF({
        workers: 2,
        quality: 10,
        width: width,
        height: height,
        workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'
      });
      
      // Store original parameters
      const originalIterations = params.iterations;
      const originalWind = params.wind;
      
      // Generate frames by growing the tree
      const totalFrames = 15;
      for (let frame = 0; frame < totalFrames; frame++) {
        statusEl.textContent = `Rendering frame ${frame + 1}/${totalFrames}...`;
        
        // Vary iterations for growth animation
        params.iterations = Math.floor((frame + 1) / totalFrames * originalIterations) + 1;
        
        // Also vary wind slightly for more organic motion
        params.wind = originalWind * sin(frame * 0.2) * 0.5;
        
        // Create offscreen canvas
        const offscreenCanvas = document.createElement('canvas');
        offscreenCanvas.width = width;
        offscreenCanvas.height = height;
        const ctx = offscreenCanvas.getContext('2d');
        
        // Draw background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, width, height);
        
        // Draw the tree at current state
        const tree = new Tree(
          params.iterations,
          params.angle,
          params.angleVariation,
          params.lengthFactor,
          params.branchProbability,
          params.wind
        );
        
        ctx.save();
        ctx.translate(width/2, height - 50);
        
        // Draw tree to offscreen canvas
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        
        // Render tree (simplified version of Tree.show())
        function drawBranch(len, depth) {
          if (depth <= 0) return;
          
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(0, -len);
          ctx.stroke();
          
          ctx.translate(0, -len);
          
          // Right branch
          if (Math.random() < params.branchProbability || depth === params.iterations) {
            ctx.save();
            ctx.rotate((params.angle + random(-params.angleVariation, params.angleVariation) + params.wind * (params.iterations - depth) * 0.1) * Math.PI / 180);
            drawBranch(len * params.lengthFactor, depth - 1);
            ctx.restore();
          }
          
          // Left branch
          if (Math.random() < params.branchProbability || depth === params.iterations) {
            ctx.save();
            ctx.rotate(-(params.angle + random(-params.angleVariation, params.angleVariation) - params.wind * (params.iterations - depth) * 0.1) * Math.PI / 180);
            drawBranch(len * params.lengthFactor, depth - 1);
            ctx.restore();
          }
        }
        
        drawBranch(100, params.iterations);
        ctx.restore();
        
        // Add frame
        gif.addFrame(ctx, {delay: 150});
      }
      
      // Restore original parameters
      params.iterations = originalIterations;
      params.wind = originalWind;
      regenerate();
      
      statusEl.textContent = 'Encoding GIF...';
      
      gif.on('finished', function(blob) {
        statusEl.textContent = 'GIF export complete!';
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `lsystem-tree.gif`;
        link.click();
        
        setTimeout(() => {
          statusEl.textContent = '';
        }, 3000);
      });
      
      gif.render();
    }
  </script>
</body>
</html>