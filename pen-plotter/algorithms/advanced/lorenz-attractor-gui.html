<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <title>Lorenz Attractor - Pen Plotter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>

  <link rel="stylesheet" href="../../shared/algorithm.css">
  <style>
    #controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: var(--bg-secondary, #1a1a2e);
      border-radius: 8px;
      max-width: 320px;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .control-group label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-secondary, #888);
    }
    .control-group input[type="range"] {
      width: 100%;
    }
    select {
      background: var(--bg-tertiary, #252540);
      color: var(--text-primary, #fff);
      border: 1px solid var(--border-color, #333);
      padding: 6px 10px;
      border-radius: 4px;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    button.primary {
      background: var(--accent-primary, #4a9eff);
      color: white;
    }
    button.secondary {
      background: var(--bg-tertiary, #252540);
      color: var(--text-primary, #fff);
      border: 1px solid var(--border-color, #444);
    }
    button:hover {
      filter: brightness(1.1);
    }
    .info-text {
      font-size: 11px;
      color: var(--text-secondary, #666);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <a href="../../index.html" class="back-link">Back to Index</a>

  <div class="ts-layout">
    <aside class="ts-control-panel">
      <h2>Lorenz Attractor</h2>

      <div id="controls">
        <div class="control-group">
          <label>Attractor Type:
            <select id="attractorType">
              <option value="lorenz">Lorenz</option>
              <option value="rossler">RÃ¶ssler</option>
              <option value="thomas">Thomas</option>
              <option value="aizawa">Aizawa</option>
              <option value="halvorsen">Halvorsen</option>
            </select>
          </label>
          <p class="info-text" id="attractor-info">Classic butterfly chaos (1963)</p>
        </div>

        <div class="control-group">
          <label>Iterations: <span id="iterations-val">8000</span></label>
          <input type="range" id="iterations" min="1000" max="30000" value="8000" step="500">
        </div>

        <div class="control-group">
          <label>Time Step (dt): <span id="dt-val">0.005</span></label>
          <input type="range" id="dt" min="0.001" max="0.02" value="0.005" step="0.001">
        </div>

        <div class="control-group">
          <label>Scale: <span id="scale-val">10</span></label>
          <input type="range" id="scale" min="3" max="25" value="10" step="0.5">
        </div>

        <div class="control-group">
          <label>Rotation X: <span id="rotX-val">15</span>Â°</label>
          <input type="range" id="rotX" min="-90" max="90" value="15">
        </div>

        <div class="control-group">
          <label>Rotation Z: <span id="rotZ-val">0</span>Â°</label>
          <input type="range" id="rotZ" min="-180" max="180" value="0">
        </div>

        <div class="control-group">
          <label>Stroke Weight: <span id="strokeWeight-val">0.5</span></label>
          <input type="range" id="strokeWeight" min="0.2" max="2" value="0.5" step="0.1">
        </div>

        <div class="control-group">
          <label>
            <input type="checkbox" id="showAxes"> Show Axes
          </label>
        </div>

        <div class="control-group">
          <label>
            <input type="checkbox" id="multiPath" checked> Multi-Path Start
          </label>
        </div>

        <div class="btn-row">
          <button class="primary" id="regenerateBtn">Regenerate</button>
        </div>

        <div class="btn-row">
          <button class="secondary" id="exportSVG">Export SVG</button>
          <button class="secondary" id="exportPNG">Export PNG</button>
        </div>

        <hr style="border-color: var(--border-color, #333); margin: 12px 0;">

        <div class="control-group">
          <label>Paper Size:
            <select id="paperSize">
              <option value="custom">Custom (800Ã—800)</option>
              <option value="A5">A5 Portrait</option>
              <option value="A5L">A5 Landscape</option>
              <option value="A4">A4 Portrait</option>
              <option value="A4L">A4 Landscape</option>
              <option value="A3">A3 Portrait</option>
              <option value="A3L">A3 Landscape</option>
              <option value="letter">Letter Portrait</option>
              <option value="letterL">Letter Landscape</option>
              <option value="square">Square (800Ã—800)</option>
            </select>
          </label>
        </div>

        <div class="control-group">
          <label>Background:
            <input type="color" id="bgColor" value="#ffffff">
          </label>
        </div>

        <div class="control-group">
          <label>Stroke Color:
            <input type="color" id="strokeColor" value="#000000">
          </label>
        </div>
      <div class="control">
        <button id="randomizeAll" class="ts-btn">ðŸŽ¨ Randomize Colors</button>
      </div>
      </div>
    </aside>

    <main class="ts-canvas-area">
      <div id="canvas-container"></div>
    </main>
  </div>

  <script src="../../shared/export-utils.js"></script>
  <script src="../../shared/canvas-layout.js"></script>
  <script src="../../shared/canvas-controls.js"></script>
  <script>
    const params = {
      attractorType: 'lorenz',
      iterations: 8000,
      dt: 0.005,
      scale: 12,
      rotX: 15,
      rotZ: 0,
      strokeWeight: 0.5,
      showAxes: false,
      multiPath: true,
      paperSize: 'custom',
      bgColor: '#ffffff',
      strokeColor: '#000000'
    };

    // Canvas controls for unified color handling
    const canvasControls = new TSCanvasControls();
    canvasControls.bind(params);

    const attractorInfo = {
      lorenz: 'Classic butterfly chaos (1963)',
      rossler: 'Spiral chaos, simpler dynamics',
      thomas: 'Cyclically symmetric attractor',
      aizawa: 'Torus-like strange attractor',
      halvorsen: 'Symmetric chaotic flow'
    };

    // Attractor parameters
    const attractorParams = {
      lorenz: { sigma: 10, rho: 28, beta: 8/3 },
      rossler: { a: 0.2, b: 0.2, c: 5.7 },
      thomas: { b: 0.208186 },
      aizawa: { a: 0.95, b: 0.7, c: 0.6, d: 3.5, e: 0.25, f: 0.1 },
      halvorsen: { a: 1.89 }
    };

    let canvas;
    let paths = [];
    let SIZE = 800;

    function setup() {
      canvas = createCanvas(SIZE, SIZE);
      canvas.parent('canvas-container');
      setupControls();
      canvasControls.setupRandomizeButton();
      generateAttractor();
    }

    function setupControls() {
      const rangeControls = ['iterations', 'dt', 'scale', 'rotX', 'rotZ', 'strokeWeight'];
      rangeControls.forEach(id => {
        const el = document.getElementById(id);
        const display = document.getElementById(`${id}-val`);
        el.addEventListener('input', () => {
          params[id] = parseFloat(el.value);
          display.textContent = el.value;
          generateAttractor();
        });
      });

      document.getElementById('attractorType').addEventListener('change', (e) => {
        params.attractorType = e.target.value;
        document.getElementById('attractor-info').textContent = attractorInfo[params.attractorType];
        generateAttractor();
      });

      document.getElementById('showAxes').addEventListener('change', (e) => {
        params.showAxes = e.target.checked;
        drawAttractor();
      });

      document.getElementById('multiPath').addEventListener('change', (e) => {
        params.multiPath = e.target.checked;
        generateAttractor();
      });

      document.getElementById('regenerateBtn').addEventListener('click', () => {
        // Randomize rotation for visible change
        params.rotZ = Math.floor(Math.random() * 360) - 180;
        document.getElementById('rotZ').value = params.rotZ;
        document.getElementById('rotZ-val').textContent = params.rotZ;
        generateAttractor();
      });

      document.getElementById('exportSVG').addEventListener('click', () => {
        const svg = generateSVG();
        TSExport.downloadSVG(svg, `${params.attractorType}-attractor`);
      });

      document.getElementById('exportPNG').addEventListener('click', () => {
        TSExport.downloadPNG(canvas.canvas, `${params.attractorType}-attractor`);
      });

      document.getElementById('paperSize').addEventListener('change', (e) => {
        params.paperSize = e.target.value;
        const size = CanvasLayout.getSize(params.paperSize);
        SIZE = Math.max(size.width, size.height);
        resizeCanvas(size.width, size.height);
        generateAttractor();
      });

      document.getElementById('bgColor').addEventListener('change', (e) => {
        params.bgColor = e.target.value;
        drawAttractor();
      });

      document.getElementById('strokeColor').addEventListener('change', (e) => {
        params.strokeColor = e.target.value;
        drawAttractor();
      });
    }

    function generateAttractor() {
      paths = [];

      // Add small random offset to starting points for visible regeneration
      const offset = () => (Math.random() - 0.5) * 0.01;
      const startPoints = params.multiPath ? [
        { x: 0.1 + offset(), y: offset(), z: offset() },
        { x: 0.1 + offset(), y: 0.1 + offset(), z: offset() },
        { x: -0.1 + offset(), y: offset(), z: offset() }
      ] : [{ x: 0.1 + offset(), y: offset(), z: offset() }];

      for (const start of startPoints) {
        const path = computePath(start.x, start.y, start.z);
        paths.push(path);
      }

      drawAttractor();
    }

    function computePath(x0, y0, z0) {
      const points = [];
      let x = x0, y = y0, z = z0;
      const dt = params.dt;
      const p = attractorParams[params.attractorType];

      for (let i = 0; i < params.iterations; i++) {
        let dx, dy, dz;

        switch (params.attractorType) {
          case 'lorenz':
            dx = p.sigma * (y - x);
            dy = x * (p.rho - z) - y;
            dz = x * y - p.beta * z;
            break;

          case 'rossler':
            dx = -y - z;
            dy = x + p.a * y;
            dz = p.b + z * (x - p.c);
            break;

          case 'thomas':
            dx = Math.sin(y) - p.b * x;
            dy = Math.sin(z) - p.b * y;
            dz = Math.sin(x) - p.b * z;
            break;

          case 'aizawa':
            dx = (z - p.b) * x - p.d * y;
            dy = p.d * x + (z - p.b) * y;
            dz = p.c + p.a * z - (z * z * z) / 3 - (x * x + y * y) * (1 + p.e * z) + p.f * z * x * x * x;
            break;

          case 'halvorsen':
            dx = -p.a * x - 4 * y - 4 * z - y * y;
            dy = -p.a * y - 4 * z - 4 * x - z * z;
            dz = -p.a * z - 4 * x - 4 * y - x * x;
            break;
        }

        x += dx * dt;
        y += dy * dt;
        z += dz * dt;

        points.push({ x, y, z });
      }

      return points;
    }

    function project3D(x, y, z) {
      // Apply rotations
      const radX = params.rotX * Math.PI / 180;
      const radZ = params.rotZ * Math.PI / 180;

      // Rotate around X axis
      let y1 = y * Math.cos(radX) - z * Math.sin(radX);
      let z1 = y * Math.sin(radX) + z * Math.cos(radX);

      // Rotate around Z axis
      let x2 = x * Math.cos(radZ) - y1 * Math.sin(radZ);
      let y2 = x * Math.sin(radZ) + y1 * Math.cos(radZ);

      // Scale and center (use canvas dimensions for non-square support)
      const scale = params.scale;
      return {
        x: width / 2 + x2 * scale,
        y: height / 2 - y2 * scale // Flip Y for screen coords
      };
    }

    function drawAttractor() {
      background(params.bgColor);
      stroke(params.strokeColor);
      strokeWeight(params.strokeWeight);
      noFill();

      // Draw axes if enabled
      if (params.showAxes) {
        strokeWeight(0.3);
        stroke(200, 0, 0);
        drawAxis(30, 0, 0);
        stroke(0, 200, 0);
        drawAxis(0, 30, 0);
        stroke(0, 0, 200);
        drawAxis(0, 0, 30);
        stroke(params.strokeColor);
        strokeWeight(params.strokeWeight);
      }

      // Draw attractor paths
      for (const path of paths) {
        beginShape();
        for (const p of path) {
          const proj = project3D(p.x, p.y, p.z);
          vertex(proj.x, proj.y);
        }
        endShape();
      }
    }

    function drawAxis(x, y, z) {
      const origin = project3D(0, 0, 0);
      const end = project3D(x, y, z);
      line(origin.x, origin.y, end.x, end.y);
    }

    function generateSVG() {
      const svgPaths = [];

      // Axes
      if (params.showAxes) {
        const colors = ['#CC0000', '#00CC00', '#0000CC'];
        const axes = [[30, 0, 0], [0, 30, 0], [0, 0, 30]];
        axes.forEach((axis, i) => {
          const origin = project3D(0, 0, 0);
          const end = project3D(axis[0], axis[1], axis[2]);
          svgPaths.push({
            d: `M ${origin.x} ${origin.y} L ${end.x} ${end.y}`,
            stroke: colors[i],
            strokeWidth: 0.3
          });
        });
      }

      // Attractor paths
      for (const path of paths) {
        const points = path.map(p => project3D(p.x, p.y, p.z));
        svgPaths.push({
          d: TSExport.pointsToPath(points, false),
          stroke: params.strokeColor
        });
      }

      const canvasSize = CanvasLayout.getSize(params.paperSize);
      return TSExport.createSVG(svgPaths, canvasSize.width, canvasSize.height, {
        backgroundColor: params.bgColor,
        strokeWidth: params.strokeWeight
      });
    }
  </script>
</body>
</html>
