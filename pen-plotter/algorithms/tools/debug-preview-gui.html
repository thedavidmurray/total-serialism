<!DOCTYPE html>
<html>
<head>
  <title>Debug Preview Mode - Pen Plotter Visualization</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
  <script src="https://unpkg.com/p5.js-svg@1.5.1"></script>
  <script src="../../../path-optimizer.js"></script>
  <!-- TODO: Missing debug-preview.js - needs to be created -->
  <!-- <script src="../../src/debug-preview.js"></script> -->
  <link rel="stylesheet" href="../../pen-plotter/shared/responsive.css">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      background: #f5f5f5;
    }
    #canvas-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      position: relative;
    }
    #controls {
      width: 350px;
      padding: 20px;
      background: white;
      height: 100vh;
      overflow-y: auto;
      box-sizing: border-box;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .control-group {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .control-group:last-child {
      border-bottom: none;
    }
    .control-group h3 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 16px;
    }
    .control {
      margin-bottom: 15px;
    }
    .control label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #666;
    }
    .control input[type="file"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
    }
    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 5px 0;
      background: #4a90e2;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    button:hover {
      background: #357abd;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .button-group {
      display: flex;
      gap: 10px;
    }
    .button-group button {
      flex: 1;
    }
    #processing-status {
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
      font-size: 14px;
      text-align: center;
      display: none;
    }
    #processing-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    #processing-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #processing-status.processing {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .stats {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .stats div {
      margin: 5px 0;
    }
    .stats strong {
      color: #333;
    }
    #canvas-wrapper {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 20px;
    }
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    .drop-zone.dragover {
      border-color: #4a90e2;
      background: #f0f7ff;
    }
    .drop-zone p {
      margin: 0;
      color: #666;
    }
    .color-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .color-control input[type="color"] {
      width: 50px;
      height: 30px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    .animation-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .animation-controls button {
      padding: 8px 12px;
      font-size: 13px;
    }
    .preview-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    .preview-tabs button {
      flex: 1;
      padding: 8px;
      background: #f0f0f0;
      color: #666;
      border: 1px solid #ddd;
    }
    .preview-tabs button.active {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <div id="canvas-wrapper"></div>
  </div>
  
  <div id="controls">
    <h2>Debug Preview Mode</h2>
    <p style="margin-top: 0; color: #666; font-size: 14px;">Visualize pen plotter movements and optimize paths</p>
    
    <div class="control-group">
      <h3>üìÅ Load Paths</h3>
      <div class="drop-zone" id="dropZone">
        <p>Drop SVG/JSON file here or click to browse</p>
        <input type="file" id="fileInput" accept=".svg,.json" style="display: none;">
      </div>
      <button onclick="loadTestPattern()">Load Test Pattern</button>
    </div>
    
    <div class="control-group">
      <h3>üëÅÔ∏è Visualization Options</h3>
      <div class="checkbox-group">
        <label>
          <input type="checkbox" id="showTravelPaths" checked> Show Travel Paths (pen up)
        </label>
        <label>
          <input type="checkbox" id="showStartEnd" checked> Show Start/End Markers
        </label>
        <label>
          <input type="checkbox" id="showDirection" checked> Show Direction Arrows
        </label>
        <label>
          <input type="checkbox" id="showPenLifts" checked> Show Pen Lift Indicators
        </label>
        <label>
          <input type="checkbox" id="showStats" checked> Show Statistics Overlay
        </label>
      </div>
    </div>
    
    <div class="control-group">
      <h3>üé® Colors</h3>
      <div class="control">
        <label>Drawing Color:</label>
        <div class="color-control">
          <input type="color" id="drawColor" value="#000000">
          <input type="range" id="drawOpacity" min="0" max="100" value="100">
          <span id="drawOpacityValue">100%</span>
        </div>
      </div>
      <div class="control">
        <label>Travel Color:</label>
        <div class="color-control">
          <input type="color" id="travelColor" value="#ff0000">
          <input type="range" id="travelOpacity" min="0" max="100" value="30">
          <span id="travelOpacityValue">30%</span>
        </div>
      </div>
    </div>
    
    <div class="control-group">
      <h3>üé≠ Preview Mode</h3>
      <div class="preview-tabs">
        <button class="active" onclick="setPreviewMode('static')">Static</button>
        <button onclick="setPreviewMode('animated')">Animated</button>
      </div>
      <div id="animationControls" style="display: none;">
        <div class="animation-controls">
          <button onclick="playAnimation()">‚ñ∂ Play</button>
          <button onclick="pauseAnimation()">‚è∏ Pause</button>
          <button onclick="resetAnimation()">‚èπ Reset</button>
        </div>
        <div class="control">
          <label>Animation Speed: <span id="animSpeedValue">1x</span></label>
          <input type="range" id="animSpeed" min="0.1" max="5" step="0.1" value="1">
        </div>
      </div>
    </div>
    
    <div class="control-group">
      <h3>‚ö° Path Optimization</h3>
      <button onclick="optimizePaths()" id="optimizeBtn" disabled>Optimize Path Order</button>
      <div class="control">
        <label>Join Threshold: <span id="joinThresholdValue">5</span>px</label>
        <input type="range" id="joinThreshold" min="0" max="20" step="1" value="5">
      </div>
      <div class="control">
        <label>Simplify Tolerance: <span id="simplifyToleranceValue">1</span>px</label>
        <input type="range" id="simplifyTolerance" min="0" max="5" step="0.1" value="1">
      </div>
    </div>
    
    <div class="control-group">
      <h3>üíæ Export</h3>
      <button onclick="exportDebugImage()" id="exportImageBtn" disabled>Export Debug Image</button>
      <button onclick="exportOptimizedSVG()" id="exportSVGBtn" disabled>Export Optimized SVG</button>
      <button onclick="exportStats()" id="exportStatsBtn" disabled>Export Statistics</button>
      <div id="processing-status"></div>
    </div>
    
    <div class="stats" id="stats" style="display: none;">
      <h4 style="margin-top: 0;">Path Statistics</h4>
      <div>Paths: <strong id="pathCount">0</strong></div>
      <div>Points: <strong id="pointCount">0</strong></div>
      <div>Pen Lifts: <strong id="penLifts">0</strong></div>
      <div>Draw Distance: <strong id="drawDistance">0</strong>mm</div>
      <div>Travel Distance: <strong id="travelDistance">0</strong>mm</div>
      <div>Total Distance: <strong id="totalDistance">0</strong>mm</div>
      <div>Efficiency: <strong id="efficiency">0</strong>%</div>
      <div>Est. Time: <strong id="estimatedTime">0s</strong></div>
    </div>
  </div>

  <script>
    // Global variables
    let debugPreview;
    let pathOptimizer;
    let currentPaths = [];
    let optimizedPaths = [];
    let canvas;
    let previewMode = 'static';
    let animationCanvas;
    let isAnimating = false;

    // Initialize
    function setup() {
      const canvasSize = 600;
      canvas = createCanvas(canvasSize, canvasSize);
      canvas.parent('canvas-wrapper');
      
      debugPreview = new DebugPreview();
      pathOptimizer = new PathOptimizer();
      
      background(255);
      
      setupEventListeners();
    }

    function setupEventListeners() {
      // File drop zone
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFileUpload(e.dataTransfer.files[0]);
      });
      
      fileInput.addEventListener('change', (e) => {
        handleFileUpload(e.target.files[0]);
      });
      
      // Visualization options
      ['showTravelPaths', 'showStartEnd', 'showDirection', 'showPenLifts', 'showStats'].forEach(id => {
        document.getElementById(id).addEventListener('change', updatePreview);
      });
      
      // Color controls
      ['drawColor', 'drawOpacity', 'travelColor', 'travelOpacity'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => {
          updateColorDisplay(e.target);
          updatePreview();
        });
      });
      
      // Sliders
      ['joinThreshold', 'simplifyTolerance', 'animSpeed'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => {
          document.getElementById(id + 'Value').textContent = e.target.value + 
            (id === 'animSpeed' ? 'x' : 'px');
        });
      });
    }

    function handleFileUpload(file) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          if (file.name.endsWith('.json')) {
            currentPaths = JSON.parse(e.target.result);
          } else if (file.name.endsWith('.svg')) {
            currentPaths = parseSVG(e.target.result);
          }
          
          optimizedPaths = [];
          updatePreview();
          enableControls();
          showStatus('File loaded successfully', 'success');
        } catch (error) {
          showStatus('Error loading file: ' + error.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    function parseSVG(svgText) {
      // Use PathOptimizer to parse SVG
      const paths = pathOptimizer.parseSVGPath(svgText);
      return paths;
    }

    function loadTestPattern() {
      // Generate test pattern with multiple paths
      currentPaths = [
        {
          points: [
            { x: 100, y: 100 },
            { x: 200, y: 100 },
            { x: 200, y: 200 },
            { x: 100, y: 200 },
            { x: 100, y: 100 }
          ],
          closed: true
        },
        {
          points: [
            { x: 250, y: 150 },
            { x: 350, y: 150 },
            { x: 300, y: 250 }
          ],
          closed: true
        },
        {
          points: generateSpiral(400, 300, 50, 5),
          closed: false
        }
      ];
      
      optimizedPaths = [];
      updatePreview();
      enableControls();
      showStatus('Test pattern loaded', 'success');
    }

    function generateSpiral(cx, cy, radius, turns) {
      const points = [];
      const steps = turns * 50;
      
      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const angle = t * turns * TWO_PI;
        const r = t * radius;
        points.push({
          x: cx + cos(angle) * r,
          y: cy + sin(angle) * r
        });
      }
      
      return points;
    }

    function updatePreview() {
      const paths = optimizedPaths.length > 0 ? optimizedPaths : currentPaths;
      if (paths.length === 0) return;
      
      // Get current options
      const options = {
        showTravelPaths: document.getElementById('showTravelPaths').checked,
        showStartEnd: document.getElementById('showStartEnd').checked,
        showDirection: document.getElementById('showDirection').checked,
        showPenLifts: document.getElementById('showPenLifts').checked,
        showStats: document.getElementById('showStats').checked,
        drawColor: hexToRgba(
          document.getElementById('drawColor').value,
          document.getElementById('drawOpacity').value / 100
        ),
        travelColor: hexToRgba(
          document.getElementById('travelColor').value,
          document.getElementById('travelOpacity').value / 100
        )
      };
      
      // Create debug preview
      debugPreview.options = { ...debugPreview.options, ...options };
      const preview = debugPreview.createPreview(paths, width, height);
      
      // Draw to p5 canvas
      clear();
      background(255);
      
      const img = createImg(preview.imageData);
      img.hide();
      image(img, 0, 0);
      
      // Update statistics
      updateStats(preview.stats);
    }

    function updateStats(stats) {
      document.getElementById('pathCount').textContent = stats.paths;
      document.getElementById('pointCount').textContent = stats.points;
      document.getElementById('penLifts').textContent = stats.penLifts;
      document.getElementById('drawDistance').textContent = stats.drawDistance;
      document.getElementById('travelDistance').textContent = stats.travelDistance;
      document.getElementById('totalDistance').textContent = stats.totalDistance;
      document.getElementById('efficiency').textContent = stats.efficiency;
      document.getElementById('estimatedTime').textContent = stats.estimatedTime;
      document.getElementById('stats').style.display = 'block';
    }

    function setPreviewMode(mode) {
      previewMode = mode;
      
      // Update tab buttons
      document.querySelectorAll('.preview-tabs button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Show/hide animation controls
      document.getElementById('animationControls').style.display = 
        mode === 'animated' ? 'block' : 'none';
      
      if (mode === 'static') {
        pauseAnimation();
        updatePreview();
      }
    }

    function playAnimation() {
      if (currentPaths.length === 0) return;
      
      const paths = optimizedPaths.length > 0 ? optimizedPaths : currentPaths;
      const speed = parseFloat(document.getElementById('animSpeed').value);
      
      isAnimating = true;
      
      // Create animated preview
      animationCanvas = debugPreview.createAnimatedPreview(
        paths,
        width,
        height,
        (canvas, state) => {
          // Update p5 canvas with animation frame
          clear();
          background(255);
          
          const img = createImg(canvas.toDataURL());
          img.hide();
          image(img, 0, 0);
          
          // Update progress
          const progress = Math.floor(state.progress * 100);
          showStatus(`Animation: ${progress}% complete`, 'processing');
        }
      );
    }

    function pauseAnimation() {
      isAnimating = false;
    }

    function resetAnimation() {
      pauseAnimation();
      updatePreview();
    }

    function optimizePaths() {
      if (currentPaths.length === 0) return;
      
      showStatus('Optimizing paths...', 'processing');
      
      try {
        // Get optimization parameters
        const joinThreshold = parseFloat(document.getElementById('joinThreshold').value);
        const simplifyTolerance = parseFloat(document.getElementById('simplifyTolerance').value);
        
        // Join nearby paths
        let paths = pathOptimizer.joinPaths(currentPaths, joinThreshold);
        
        // Simplify paths
        paths = paths.map(path => ({
          ...path,
          points: pathOptimizer.simplifyPath(path.points, simplifyTolerance)
        }));
        
        // Optimize order (TSP)
        optimizedPaths = pathOptimizer.optimizeOrder(paths);
        
        updatePreview();
        showStatus('Paths optimized successfully', 'success');
      } catch (error) {
        showStatus('Optimization error: ' + error.message, 'error');
      }
    }

    function exportDebugImage() {
      const paths = optimizedPaths.length > 0 ? optimizedPaths : currentPaths;
      if (paths.length === 0) return;
      
      // Create high-res preview
      const preview = debugPreview.createPreview(paths, 1200, 1200);
      
      // Download image
      const link = document.createElement('a');
      link.download = 'debug-preview.png';
      link.href = preview.imageData;
      link.click();
      
      showStatus('Debug image exported', 'success');
    }

    function exportOptimizedSVG() {
      const paths = optimizedPaths.length > 0 ? optimizedPaths : currentPaths;
      if (paths.length === 0) return;
      
      // Convert to SVG
      const svg = pathOptimizer.cleanSVG(pathOptimizer.toSVGPath(paths));
      
      // Create full SVG document
      const svgDoc = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" stroke="black" stroke-width="1">
    ${paths.map(path => 
      `<path d="${pathOptimizer.toSVGPath([path])}" />`
    ).join('\n    ')}
  </g>
</svg>`;
      
      // Download SVG
      const blob = new Blob([svgDoc], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = 'optimized-paths.svg';
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
      
      showStatus('SVG exported', 'success');
    }

    function exportStats() {
      const stats = document.getElementById('stats').innerText;
      
      const blob = new Blob([stats], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = 'path-statistics.txt';
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
      
      showStatus('Statistics exported', 'success');
    }

    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function updateColorDisplay(input) {
      if (input.type === 'range') {
        const valueSpan = document.getElementById(input.id + 'Value');
        if (valueSpan) {
          valueSpan.textContent = input.value + '%';
        }
      }
    }

    function enableControls() {
      document.getElementById('optimizeBtn').disabled = false;
      document.getElementById('exportImageBtn').disabled = false;
      document.getElementById('exportSVGBtn').disabled = false;
      document.getElementById('exportStatsBtn').disabled = false;
    }

    function showStatus(message, type) {
      const status = document.getElementById('processing-status');
      status.textContent = message;
      status.className = type;
      status.style.display = 'block';
      
      if (type !== 'processing') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 3000);
      }
    }
  </script>
</body>
</html>